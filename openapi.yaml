openapi: 3.0.3
info:
  title: Airport Transfer Marketplace API
  version: 2.2.0
  description: |
    Independent Airport Transfer Marketplace API.

    ## What's New in v2.2.0
    - **Cryptocurrency Payments**: Accept Bitcoin, Ethereum, and XRP payments
    - **Live Crypto Rates**: Real-time EUR to crypto conversion via CoinGecko
    - **Driver Assignment Reminders**: Automated supplier notifications 5 hours before pickup
    - **Enhanced Tracking**: Fixed real-time booking tracking API

    ## What's New in v2.1.0
    - **Promo Codes**: Create and manage discount codes with usage tracking
    - **Customer Accounts**: Customer registration with Google OAuth support
    - **Webhooks**: Real-time notifications for booking events
    - **Rate Limiting**: All public endpoints include rate limit headers

    Covers authentication, suppliers, airports/zones/routes, pricing, bookings, rides, and payments.

    ## Role-Based Access Control

    - `GET /public/*`, `POST /public/*`, `/webhooks/*`: **no authentication**
    - `/auth/*`: no authentication
    - `/supplier/*`: requires JWT with roles: `SUPPLIER_OWNER`, `DISPATCHER`, or `DRIVER`
    - `/admin/*`: requires JWT with role: `ADMIN`

    ## Currency Handling

    - Marketplace operates in **EUR** as base currency
    - Suppliers can set prices in their local currency (TRY, USD, GBP, etc.)
    - Currency conversion happens at booking time using real-time rates
    - Supplier payouts are made in their configured payout currency

    ## Cancellation Policy

    - Free cancellation up to **24 hours** before pickup
    - **50% refund** for cancellations **12â€“24 hours** before pickup
    - **No refund** for cancellations less than **12 hours** before pickup
    - Supplier cancellations result in full refund + possible compensation

servers:
  - url: https://api.airporttransferportal.com
    description: Production server
  - url: http://localhost:3000
    description: Development server

tags:
  - name: Auth
    description: Authentication & user management
  - name: Public
    description: Public endpoints for searching and booking transfers (no auth required)
  - name: Supplier
    description: Supplier / transfer company operations
  - name: Admin
    description: Admin-level management endpoints
  - name: Dispatch
    description: Dispatch operations for driver tracking, flight monitoring, and issue management
  - name: Agency
    description: Agency portal operations for B2B partners
  - name: V1 API
    description: Version 1 B2B API for agency integrations (API Key authentication)
  - name: Promo Codes
    description: Promo code management and validation
  - name: Customer
    description: Customer account management, authentication, and booking history
  - name: Webhooks
    description: Webhook subscriptions for real-time event notifications
  - name: Crypto
    description: Cryptocurrency payment endpoints (BTC, ETH, XRP)
  - name: Cron
    description: Scheduled job endpoints (internal use)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    apiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for agency integrations

  schemas:
    Role:
      type: string
      enum: [ADMIN, SUPPLIER_OWNER, DISPATCHER, DRIVER, END_CUSTOMER]

    VehicleType:
      type: string
      enum: [SEDAN, VAN, MINIBUS, BUS, VIP]

    RouteDirection:
      type: string
      enum: [FROM_AIRPORT, TO_AIRPORT, BOTH]

    BookingChannel:
      type: string
      enum: [B2C, B2B, AGENCY_API]

    BookingStatus:
      type: string
      enum: [PENDING, AWAITING_PAYMENT, CONFIRMED, ASSIGNED, IN_PROGRESS, COMPLETED, CANCELLED]

    PaymentStatus:
      type: string
      enum: [UNPAID, PENDING, PENDING_VERIFICATION, PARTIALLY_PAID, PAID, REFUNDED, CANCELLED]

    PaymentMethod:
      type: string
      enum: [PAY_LATER, CARD, BANK_TRANSFER, CRYPTO]
      description: |
        - PAY_LATER: Pay driver directly at pickup
        - CARD: Online card payment
        - BANK_TRANSFER: Bank transfer before service
        - CRYPTO: Cryptocurrency payment (BTC, ETH, XRP)

    CryptoCurrency:
      type: string
      enum: [BTC, ETH, XRP]
      description: Supported cryptocurrencies for payment

    RideStatus:
      type: string
      enum:
        - PENDING_ASSIGN
        - ASSIGNED
        - ON_WAY
        - AT_PICKUP
        - IN_RIDE
        - FINISHED
        - NO_SHOW
        - CANCELLED

    PaymentProviderStatus:
      type: string
      enum: [PENDING, SUCCESS, FAILED, REFUNDED]

    SupplierPayoutStatus:
      type: string
      enum: [PENDING, SCHEDULED, PAID, CANCELLED]

    TariffRuleType:
      type: string
      enum: [TIME_OF_DAY, DAY_OF_WEEK, SEASON, LAST_MINUTE]

    User:
      type: object
      properties:
        id:
          type: integer
          format: int64
        email:
          type: string
          format: email
        fullName:
          type: string
        phone:
          type: string
        role:
          $ref: '#/components/schemas/Role'
        isActive:
          type: boolean

    Airport:
      type: object
      properties:
        id:
          type: integer
          format: int64
        code:
          type: string
          example: IST
        name:
          type: string
        city:
          type: string
        country:
          type: string
        timezone:
          type: string
          example: Europe/Istanbul
        isActive:
          type: boolean

    Zone:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
          example: Sultanahmet
        city:
          type: string
        country:
          type: string
        isActive:
          type: boolean

    Route:
      type: object
      properties:
        id:
          type: integer
          format: int64
        airport:
          $ref: '#/components/schemas/Airport'
        zone:
          $ref: '#/components/schemas/Zone'
        direction:
          $ref: '#/components/schemas/RouteDirection'
        approxDistanceKm:
          type: number
          format: double
        approxDurationMin:
          type: integer
        isActive:
          type: boolean

    Supplier:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
        contactName:
          type: string
        contactEmail:
          type: string
        contactPhone:
          type: string
        country:
          type: string
        city:
          type: string
        taxNumber:
          type: string
        legalName:
          type: string
        isVerified:
          type: boolean
        commissionRate:
          type: number
          format: double

    Vehicle:
      type: object
      properties:
        id:
          type: integer
          format: int64
        supplierId:
          type: integer
          format: int64
        plateNumber:
          type: string
        brand:
          type: string
        model:
          type: string
        year:
          type: integer
        seatCount:
          type: integer
        luggageCount:
          type: integer
        vehicleType:
          $ref: '#/components/schemas/VehicleType'
        isActive:
          type: boolean

    Driver:
      type: object
      properties:
        id:
          type: integer
          format: int64
        supplierId:
          type: integer
          format: int64
        userId:
          type: integer
          format: int64
        licenseNumber:
          type: string
        phone:
          type: string
        isActive:
          type: boolean
        ratingAvg:
          type: number
          format: double
        ratingCount:
          type: integer

    Tariff:
      type: object
      properties:
        id:
          type: integer
          format: int64
        supplierId:
          type: integer
          format: int64
        routeId:
          type: integer
          format: int64
        vehicleType:
          $ref: '#/components/schemas/VehicleType'
        currency:
          type: string
          example: EUR
        basePrice:
          type: number
          format: double
        pricePerPax:
          type: number
          format: double
          nullable: true
        minPax:
          type: integer
        maxPax:
          type: integer
          nullable: true
        validFrom:
          type: string
          format: date
          nullable: true
        validTo:
          type: string
          format: date
          nullable: true
        isActive:
          type: boolean

    TariffRule:
      type: object
      properties:
        id:
          type: integer
          format: int64
        tariffId:
          type: integer
          format: int64
        ruleType:
          $ref: '#/components/schemas/TariffRuleType'
        dayOfWeek:
          type: integer
          minimum: 1
          maximum: 7
          nullable: true
        startTime:
          type: string
          format: time
          nullable: true
        endTime:
          type: string
          format: time
          nullable: true
        seasonFrom:
          type: string
          format: date
          nullable: true
        seasonTo:
          type: string
          format: date
          nullable: true
        percAdjustment:
          type: number
          format: double
          nullable: true
        fixedAdjustment:
          type: number
          format: double
          nullable: true

    Booking:
      type: object
      properties:
        id:
          type: integer
          format: int64
        publicCode:
          type: string
          example: ABC123
        customerId:
          type: integer
          format: int64
          nullable: true
        channel:
          $ref: '#/components/schemas/BookingChannel'
        agencyName:
          type: string
          nullable: true
        airport:
          $ref: '#/components/schemas/Airport'
        zone:
          $ref: '#/components/schemas/Zone'
        direction:
          $ref: '#/components/schemas/RouteDirection'
        flightNumber:
          type: string
          nullable: true
        flightDate:
          type: string
          format: date
          nullable: true
        flightTime:
          type: string
          format: time
          nullable: true
        pickupTime:
          type: string
          format: date-time
        paxAdults:
          type: integer
        paxChildren:
          type: integer
        vehicleType:
          $ref: '#/components/schemas/VehicleType'
        currency:
          type: string
        totalPrice:
          type: number
          format: double
        status:
          $ref: '#/components/schemas/BookingStatus'
        paymentStatus:
          $ref: '#/components/schemas/PaymentStatus'

    Passenger:
      type: object
      properties:
        id:
          type: integer
          format: int64
        bookingId:
          type: integer
          format: int64
        fullName:
          type: string
        phone:
          type: string
        email:
          type: string
        isMain:
          type: boolean

    Ride:
      type: object
      properties:
        id:
          type: integer
          format: int64
        bookingId:
          type: integer
          format: int64
        supplierId:
          type: integer
          format: int64
        vehicleId:
          type: integer
          format: int64
          nullable: true
        driverId:
          type: integer
          format: int64
          nullable: true
        status:
          $ref: '#/components/schemas/RideStatus'
        pickupLat:
          type: number
          format: double
          nullable: true
        pickupLng:
          type: number
          format: double
          nullable: true
        dropoffLat:
          type: number
          format: double
          nullable: true
        dropoffLng:
          type: number
          format: double
          nullable: true
        driverNote:
          type: string
          nullable: true

    Payment:
      type: object
      properties:
        id:
          type: integer
          format: int64
        bookingId:
          type: integer
          format: int64
        amount:
          type: number
          format: double
        currency:
          type: string
        provider:
          type: string
        providerTxid:
          type: string
        status:
          $ref: '#/components/schemas/PaymentProviderStatus'

    SupplierPayout:
      type: object
      properties:
        id:
          type: integer
          format: int64
        supplierId:
          type: integer
          format: int64
        bookingId:
          type: integer
          format: int64
        amount:
          type: number
          format: double
        currency:
          type: string
        status:
          $ref: '#/components/schemas/SupplierPayoutStatus'
        dueDate:
          type: string
          format: date
          nullable: true
        paidAt:
          type: string
          format: date-time
          nullable: true

    AirportCreate:
      type: object
      required: [code, name]
      properties:
        code:
          type: string
        name:
          type: string
        city:
          type: string
        country:
          type: string
        timezone:
          type: string

    ZoneCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
        city:
          type: string
        country:
          type: string

    RouteCreate:
      type: object
      required: [airportId, zoneId, direction]
      properties:
        airportId:
          type: integer
          format: int64
        zoneId:
          type: integer
          format: int64
        direction:
          $ref: '#/components/schemas/RouteDirection'
        approxDistanceKm:
          type: number
          format: double
        approxDurationMin:
          type: integer

    SupplierCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
        contactName:
          type: string
        contactEmail:
          type: string
        contactPhone:
          type: string
        country:
          type: string
        city:
          type: string
        taxNumber:
          type: string
        legalName:
          type: string
        commissionRate:
          type: number
          format: double

    VehicleCreate:
      type: object
      required: [plateNumber, vehicleType, seatCount]
      properties:
        plateNumber:
          type: string
        brand:
          type: string
        model:
          type: string
        year:
          type: integer
        seatCount:
          type: integer
        luggageCount:
          type: integer
        vehicleType:
          $ref: '#/components/schemas/VehicleType'

    DriverCreate:
      type: object
      required: [fullName, phone]
      properties:
        fullName:
          type: string
        phone:
          type: string
        email:
          type: string
        licenseNumber:
          type: string

    TariffCreate:
      type: object
      required: [routeId, vehicleType, currency, basePrice]
      properties:
        routeId:
          type: integer
          format: int64
        vehicleType:
          $ref: '#/components/schemas/VehicleType'
        currency:
          type: string
        basePrice:
          type: number
          format: double
        pricePerPax:
          type: number
          format: double
          nullable: true
        minPax:
          type: integer
          default: 1
        maxPax:
          type: integer
          nullable: true
        validFrom:
          type: string
          format: date
          nullable: true
        validTo:
          type: string
          format: date
          nullable: true

    TariffRuleCreate:
      type: object
      required: [ruleType]
      properties:
        ruleType:
          $ref: '#/components/schemas/TariffRuleType'
        dayOfWeek:
          type: integer
          minimum: 1
          maximum: 7
          nullable: true
        startTime:
          type: string
          format: time
          nullable: true
        endTime:
          type: string
          format: time
          nullable: true
        seasonFrom:
          type: string
          format: date
          nullable: true
        seasonTo:
          type: string
          format: date
          nullable: true
        percAdjustment:
          type: number
          format: double
          nullable: true
        fixedAdjustment:
          type: number
          format: double
          nullable: true

    TransferSearchRequest:
      type: object
      required:
        - airportId
        - zoneId
        - direction
        - pickupTime
        - paxAdults
        - currency
      properties:
        airportId:
          type: integer
          format: int64
        zoneId:
          type: integer
          format: int64
        direction:
          $ref: '#/components/schemas/RouteDirection'
        pickupTime:
          type: string
          format: date-time
        paxAdults:
          type: integer
        paxChildren:
          type: integer
          default: 0
        currency:
          type: string
          example: EUR

    TransferOption:
      type: object
      properties:
        supplier:
          $ref: '#/components/schemas/Supplier'
        vehicleType:
          $ref: '#/components/schemas/VehicleType'
        currency:
          type: string
        totalPrice:
          type: number
          format: double
        estimatedDurationMin:
          type: integer
        cancellationPolicy:
          type: string
        optionCode:
          type: string
          description: Internal code used when creating booking from this option.

    TransferSearchResponse:
      type: object
      properties:
        options:
          type: array
          items:
            $ref: '#/components/schemas/TransferOption'

    CreateBookingRequest:
      type: object
      required:
        - optionCode
        - channel
        - mainPassenger
      properties:
        optionCode:
          type: string
          description: Option code returned from search endpoint
        channel:
          $ref: '#/components/schemas/BookingChannel'
        agencyName:
          type: string
          nullable: true
        mainPassenger:
          type: object
          required: [fullName, phone]
          properties:
            fullName:
              type: string
            phone:
              type: string
            email:
              type: string
        additionalPassengers:
          type: array
          items:
            type: object
            properties:
              fullName:
                type: string
              phone:
                type: string
              email:
                type: string

    CreateBookingResponse:
      type: object
      properties:
        booking:
          $ref: '#/components/schemas/Booking'
        passengers:
          type: array
          items:
            $ref: '#/components/schemas/Passenger'

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    LoginResponse:
      type: object
      properties:
        accessToken:
          type: string
        user:
          $ref: '#/components/schemas/User'

    RegisterRequest:
      type: object
      required:
        - email
        - password
        - fullName
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
        fullName:
          type: string
        phone:
          type: string
        role:
          $ref: '#/components/schemas/Role'

    PaginatedResponse:
      type: object
      properties:
        items:
          type: array
          items: {}
        total:
          type: integer
        page:
          type: integer
        pageSize:
          type: integer

    ErrorResponse:
      type: object
      properties:
        statusCode:
          type: integer
        error:
          type: string
        message:
          type: string

    # Document Schemas
    DocumentType:
      type: string
      enum: [BUSINESS_LICENSE, TAX_CERTIFICATE, INSURANCE, TRANSPORT_LICENSE, COMPANY_REGISTRATION, OTHER]

    DriverDocumentType:
      type: string
      enum: [ID_CARD, LICENSE, PHOTO, CRIMINAL_RECORD, MEDICAL, OTHER]

    VehicleDocumentType:
      type: string
      enum: [REGISTRATION, INSURANCE, INSPECTION, PERMIT, OTHER]

    Document:
      type: object
      properties:
        id:
          type: integer
        supplierId:
          type: integer
        docType:
          $ref: '#/components/schemas/DocumentType'
        docName:
          type: string
        fileUrl:
          type: string
        expiryDate:
          type: string
          format: date
          nullable: true
        isVerified:
          type: boolean
        verifiedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time

    DriverDocument:
      type: object
      properties:
        id:
          type: integer
        driverId:
          type: integer
        docType:
          $ref: '#/components/schemas/DriverDocumentType'
        docName:
          type: string
        fileUrl:
          type: string
        expiryDate:
          type: string
          format: date
          nullable: true
        isVerified:
          type: boolean
        createdAt:
          type: string
          format: date-time

    VehicleDocument:
      type: object
      properties:
        id:
          type: integer
        vehicleId:
          type: integer
        docType:
          $ref: '#/components/schemas/VehicleDocumentType'
        docName:
          type: string
        fileUrl:
          type: string
        expiryDate:
          type: string
          format: date
          nullable: true
        isVerified:
          type: boolean
        createdAt:
          type: string
          format: date-time

    # Bank/Payment Schemas
    PaymentMethod:
      type: string
      enum: [BANK_TRANSFER, PAYPAL, WISE, OTHER]

    BankDetails:
      type: object
      properties:
        bankName:
          type: string
          nullable: true
        bankAccountName:
          type: string
          nullable: true
        bankIban:
          type: string
          nullable: true
        bankSwift:
          type: string
          nullable: true
        bankCountry:
          type: string
          nullable: true
        paymentEmail:
          type: string
          nullable: true
        preferredPaymentMethod:
          $ref: '#/components/schemas/PaymentMethod'

    # Review Schemas
    Review:
      type: object
      properties:
        id:
          type: integer
        bookingId:
          type: integer
        supplierId:
          type: integer
        customerId:
          type: integer
          nullable: true
        customerName:
          type: string
        ratingOverall:
          type: number
          minimum: 1
          maximum: 5
        ratingPunctuality:
          type: number
          minimum: 1
          maximum: 5
          nullable: true
        ratingVehicle:
          type: number
          minimum: 1
          maximum: 5
          nullable: true
        ratingDriver:
          type: number
          minimum: 1
          maximum: 5
          nullable: true
        reviewText:
          type: string
          nullable: true
        supplierResponse:
          type: string
          nullable: true
        respondedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time

    # Agency Schemas
    Agency:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        contactName:
          type: string
        contactEmail:
          type: string
        creditBalance:
          type: number
        currency:
          type: string
        commissionRate:
          type: number
        isActive:
          type: boolean

    # Service Zone Schema
    ServiceZone:
      type: object
      properties:
        id:
          type: integer
        supplierId:
          type: integer
        airportId:
          type: integer
        airportCode:
          type: string
        airportName:
          type: string
        maxDistanceKm:
          type: number
          nullable: true
        isActive:
          type: boolean

    # Dispatch Schemas
    DriverLocationStatus:
      type: string
      enum: [ONLINE, OFFLINE, ON_TRIP, BREAK]

    FlightTrackingStatus:
      type: string
      enum: [SCHEDULED, DEPARTED, EN_ROUTE, LANDED, ARRIVED_GATE, CANCELLED, DIVERTED, DELAYED, UNKNOWN]

    DispatchIssueSeverity:
      type: string
      enum: [LOW, MEDIUM, HIGH, CRITICAL]

    DispatchIssueStatus:
      type: string
      enum: [OPEN, IN_PROGRESS, RESOLVED, ESCALATED, CLOSED]

    DispatchIssueType:
      type: string
      enum: [NO_SHOW_CUSTOMER, NO_SHOW_DRIVER, DRIVER_LATE, VEHICLE_BREAKDOWN, ACCIDENT, CUSTOMER_COMPLAINT, DRIVER_COMPLAINT, PAYMENT_ISSUE, FLIGHT_ISSUE, ADDRESS_ISSUE, OTHER]

    NotificationRecipientType:
      type: string
      enum: [CUSTOMER, DRIVER, SUPPLIER, DISPATCHER, AGENCY]

    NotificationType:
      type: string
      enum: [BOOKING_CONFIRMED, DRIVER_ASSIGNED, DRIVER_EN_ROUTE, DRIVER_ARRIVED, TRIP_STARTED, TRIP_COMPLETED, FLIGHT_DELAYED, PICKUP_TIME_CHANGED, BOOKING_CANCELLED, REVIEW_REQUEST, PAYMENT_RECEIVED, PAYOUT_SENT, DOCUMENT_EXPIRING, GENERAL]

    NotificationChannel:
      type: string
      enum: [EMAIL, SMS, PUSH, WHATSAPP, IN_APP]

    NotificationStatus:
      type: string
      enum: [PENDING, SENT, DELIVERED, FAILED, READ]

    MessageSenderType:
      type: string
      enum: [CUSTOMER, DRIVER, DISPATCHER, SYSTEM]

    MessageType:
      type: string
      enum: [TEXT, IMAGE, LOCATION, SYSTEM]

    DriverLocation:
      type: object
      properties:
        id:
          type: integer
        driverId:
          type: integer
        name:
          type: string
        phone:
          type: string
        supplier:
          type: string
        location:
          type: object
          properties:
            lat:
              type: number
            lng:
              type: number
            heading:
              type: number
            speed:
              type: number
            accuracy:
              type: number
            batteryLevel:
              type: integer
        status:
          $ref: '#/components/schemas/DriverLocationStatus'
        currentRideId:
          type: integer
          nullable: true
        bookingCode:
          type: string
          nullable: true
        lastUpdated:
          type: string
          format: date-time

    FlightTracking:
      type: object
      properties:
        id:
          type: integer
        bookingId:
          type: integer
        bookingCode:
          type: string
        flightNumber:
          type: string
        flightDate:
          type: string
          format: date
        departureAirport:
          type: string
        arrivalAirport:
          type: string
        scheduledDeparture:
          type: string
          format: date-time
          nullable: true
        scheduledArrival:
          type: string
          format: date-time
        estimatedArrival:
          type: string
          format: date-time
          nullable: true
        actualArrival:
          type: string
          format: date-time
          nullable: true
        status:
          $ref: '#/components/schemas/FlightTrackingStatus'
        delayMinutes:
          type: integer
        delayReason:
          type: string
          nullable: true
        terminal:
          type: string
          nullable: true
        gate:
          type: string
          nullable: true
        baggageClaim:
          type: string
          nullable: true
        trackingSource:
          type: string
          nullable: true
        lastChecked:
          type: string
          format: date-time
          nullable: true
        customerName:
          type: string
        pickupTime:
          type: string
          format: date-time
        pickupAdjusted:
          type: boolean

    DispatchIssue:
      type: object
      properties:
        id:
          type: integer
        bookingId:
          type: integer
          nullable: true
        bookingCode:
          type: string
          nullable: true
        rideId:
          type: integer
          nullable: true
        driverId:
          type: integer
          nullable: true
        supplierId:
          type: integer
          nullable: true
        type:
          $ref: '#/components/schemas/DispatchIssueType'
        severity:
          $ref: '#/components/schemas/DispatchIssueSeverity'
        title:
          type: string
        description:
          type: string
          nullable: true
        status:
          $ref: '#/components/schemas/DispatchIssueStatus'
        resolution:
          type: string
          nullable: true
        reportedBy:
          type: string
        reporterId:
          type: integer
          nullable: true
        resolvedBy:
          type: integer
          nullable: true
        resolvedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        customerName:
          type: string
          nullable: true
        driverName:
          type: string
          nullable: true
        supplierName:
          type: string
          nullable: true

    Notification:
      type: object
      properties:
        id:
          type: integer
        recipientType:
          $ref: '#/components/schemas/NotificationRecipientType'
        recipientId:
          type: integer
          nullable: true
        recipientEmail:
          type: string
          nullable: true
        recipientPhone:
          type: string
          nullable: true
        type:
          $ref: '#/components/schemas/NotificationType'
        title:
          type: string
        message:
          type: string
        bookingId:
          type: integer
          nullable: true
        bookingCode:
          type: string
          nullable: true
        rideId:
          type: integer
          nullable: true
        channel:
          $ref: '#/components/schemas/NotificationChannel'
        status:
          $ref: '#/components/schemas/NotificationStatus'
        sentAt:
          type: string
          format: date-time
          nullable: true
        deliveredAt:
          type: string
          format: date-time
          nullable: true
        readAt:
          type: string
          format: date-time
          nullable: true
        errorMessage:
          type: string
          nullable: true
        metadata:
          type: object
          nullable: true
        createdAt:
          type: string
          format: date-time

    Message:
      type: object
      properties:
        id:
          type: integer
        bookingId:
          type: integer
        rideId:
          type: integer
          nullable: true
        senderType:
          $ref: '#/components/schemas/MessageSenderType'
        senderId:
          type: integer
          nullable: true
        senderName:
          type: string
          nullable: true
        message:
          type: string
        messageType:
          $ref: '#/components/schemas/MessageType'
        attachmentUrl:
          type: string
          nullable: true
        location:
          type: object
          nullable: true
          properties:
            lat:
              type: number
            lng:
              type: number
        isRead:
          type: boolean
        readAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time

    Conversation:
      type: object
      properties:
        id:
          type: integer
        bookingId:
          type: integer
        bookingCode:
          type: string
        customerName:
          type: string
        driverName:
          type: string
          nullable: true
        lastMessage:
          type: string
        lastMessageTime:
          type: string
          format: date-time
        unreadCount:
          type: integer
        status:
          type: string

    # Promo Code Schemas
    PromoCode:
      type: object
      properties:
        id:
          type: integer
          format: int64
        code:
          type: string
          example: SAVE10
        description:
          type: string
          nullable: true
        discountType:
          type: string
          enum: [PERCENTAGE, FIXED_AMOUNT]
        discountValue:
          type: number
          format: double
        currency:
          type: string
          example: EUR
        minBookingAmount:
          type: number
          format: double
        maxDiscountAmount:
          type: number
          format: double
          nullable: true
        usageLimit:
          type: integer
          nullable: true
        usageCount:
          type: integer
        perUserLimit:
          type: integer
        validFrom:
          type: string
          format: date-time
        validUntil:
          type: string
          format: date-time
          nullable: true
        isActive:
          type: boolean
        isExitIntent:
          type: boolean
        applicableRoutes:
          type: array
          items:
            type: integer
          nullable: true
        applicableVehicleTypes:
          type: array
          items:
            $ref: '#/components/schemas/VehicleType'
          nullable: true
        createdAt:
          type: string
          format: date-time

    PromoCodeValidationResult:
      type: object
      properties:
        valid:
          type: boolean
        promoCode:
          type: object
          properties:
            id:
              type: integer
            code:
              type: string
            description:
              type: string
            discountType:
              type: string
            discountValue:
              type: number
            currency:
              type: string
        discount:
          type: object
          properties:
            amount:
              type: number
            currency:
              type: string
            displayText:
              type: string
        finalAmount:
          type: number
          nullable: true
        error:
          type: string

    # Customer Schemas
    Customer:
      type: object
      properties:
        id:
          type: integer
          format: int64
        email:
          type: string
          format: email
        firstName:
          type: string
        lastName:
          type: string
        phone:
          type: string
        avatarUrl:
          type: string
          nullable: true
        isEmailVerified:
          type: boolean
        hasGoogleLinked:
          type: boolean
        preferredCurrency:
          type: string
          example: EUR
        totalBookings:
          type: integer
        loyaltyPoints:
          type: integer

    CustomerAuthRequest:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          enum: [register, login, google, logout]
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        firstName:
          type: string
        lastName:
          type: string
        phone:
          type: string
        marketingConsent:
          type: boolean
        credential:
          type: string
          description: Google OAuth credential token

    CustomerAuthResponse:
      type: object
      properties:
        success:
          type: boolean
        customer:
          $ref: '#/components/schemas/Customer'
        token:
          type: string
          description: Session token for authenticated requests
        isNewUser:
          type: boolean
          description: True if this is a new registration via Google
        message:
          type: string

    # Webhook Schemas
    WebhookEventType:
      type: string
      enum:
        - booking.created
        - booking.confirmed
        - booking.cancelled
        - booking.modified
        - booking.assigned
        - ride.started
        - ride.completed
        - ride.no_show
        - payment.received
        - payment.refunded

    WebhookSubscription:
      type: object
      properties:
        id:
          type: integer
          format: int64
        endpointUrl:
          type: string
          format: uri
        events:
          type: array
          items:
            $ref: '#/components/schemas/WebhookEventType'
        isActive:
          type: boolean
        failureCount:
          type: integer
        lastSuccessAt:
          type: string
          format: date-time
          nullable: true
        lastFailureAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time

    WebhookPayload:
      type: object
      properties:
        event:
          $ref: '#/components/schemas/WebhookEventType'
        timestamp:
          type: string
          format: date-time
        data:
          type: object
          additionalProperties: true

    # Rate Limit Headers
    RateLimitHeaders:
      type: object
      description: Rate limiting information returned in response headers
      properties:
        X-RateLimit-Limit:
          type: integer
          description: Maximum requests allowed in the window
        X-RateLimit-Remaining:
          type: integer
          description: Remaining requests in current window
        X-RateLimit-Reset:
          type: integer
          description: Unix timestamp when the rate limit resets
        Retry-After:
          type: integer
          description: Seconds to wait before retrying (only on 429 responses)

    RateLimitError:
      type: object
      properties:
        error:
          type: string
          example: Too Many Requests
        message:
          type: string
          example: Rate limit exceeded. Please try again in 30 seconds.
        retryAfter:
          type: integer
          example: 30

paths:
  /auth/register:
    post:
      tags: [Auth]
      summary: Register new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/login:
    post:
      tags: [Auth]
      summary: Login and get JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /public/airports:
    get:
      tags: [Public]
      summary: List active airports
      responses:
        '200':
          description: List of airports
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Airport'

  /public/zones:
    get:
      tags: [Public]
      summary: List zones, optionally filtered by airport
      parameters:
        - in: query
          name: airportId
          schema:
            type: integer
            format: int64
          required: false
      responses:
        '200':
          description: List of zones
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Zone'

  /public/search-transfers:
    post:
      tags: [Public]
      summary: Search transfer options for given route and time
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransferSearchRequest'
      responses:
        '200':
          description: List of available transfer options
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransferSearchResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /public/bookings:
    post:
      tags: [Public]
      summary: Create booking from selected transfer option
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBookingRequest'
      responses:
        '201':
          description: Booking created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateBookingResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /public/bookings/{publicCode}:
    get:
      tags: [Public]
      summary: Get booking by public code for customer
      parameters:
        - in: path
          name: publicCode
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Booking details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Booking'
        '404':
          description: Booking not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /public/bookings/{bookingId}/pay:
    post:
      tags: [Public]
      summary: Initiate payment for a booking
      parameters:
        - in: path
          name: bookingId
          required: true
          schema:
            type: integer
            format: int64
        - in: header
          name: Idempotency-Key
          required: false
          schema:
            type: string
          description: Used to safely retry payment without double-charging
      responses:
        '200':
          description: Payment initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
        '400':
          description: Cannot pay this booking
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /webhooks/payment:
    post:
      tags: [Public]
      summary: Payment provider webhook
      description: |
        Called by payment provider to notify about payment status changes.
        Should be secured by a shared secret or IP whitelist.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Payment'
      responses:
        '200':
          description: Webhook received
        '400':
          description: Invalid payload

  /supplier/me:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
        - DRIVER
      summary: Get current supplier user profile and supplier info
      responses:
        '200':
          description: Supplier profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
                  supplier:
                    $ref: '#/components/schemas/Supplier'
        '401':
          description: Unauthorized

  /supplier/vehicles:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
      summary: List vehicles for current supplier
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: pageSize
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of vehicles
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PaginatedResponse'
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/Vehicle'
        '401':
          description: Unauthorized
    post:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
      summary: Create new vehicle for current supplier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VehicleCreate'
      responses:
        '201':
          description: Vehicle created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vehicle'
        '400':
          description: Validation error

  /supplier/drivers:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
      summary: List drivers for current supplier
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: pageSize
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of drivers
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PaginatedResponse'
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/Driver'
    post:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
      summary: Create new driver for current supplier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DriverCreate'
      responses:
        '201':
          description: Driver created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Driver'

  /supplier/tariffs:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
      summary: List tariffs for current supplier
      parameters:
        - in: query
          name: routeId
          schema:
            type: integer
            format: int64
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: pageSize
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of tariffs
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PaginatedResponse'
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/Tariff'
    post:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
      summary: Create new tariff for current supplier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TariffCreate'
      responses:
        '201':
          description: Tariff created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tariff'

  /supplier/tariffs/{tariffId}:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
      summary: Get tariff details with rules
      parameters:
        - in: path
          name: tariffId
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Tariff details
          content:
            application/json:
              schema:
                type: object
                properties:
                  tariff:
                    $ref: '#/components/schemas/Tariff'
                  rules:
                    type: array
                    items:
                      $ref: '#/components/schemas/TariffRule'

  /supplier/tariffs/{tariffId}/rules:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
      summary: List rules for a tariff
      parameters:
        - in: path
          name: tariffId
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Tariff rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TariffRule'
    post:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
      summary: Add pricing rule to a tariff
      parameters:
        - in: path
          name: tariffId
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TariffRuleCreate'
      responses:
        '201':
          description: Tariff rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TariffRule'

  /supplier/rides:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
        - DRIVER
      summary: List rides for current supplier
      parameters:
        - in: query
          name: status
          schema:
            $ref: '#/components/schemas/RideStatus'
        - in: query
          name: fromDate
          schema:
            type: string
            format: date
        - in: query
          name: toDate
          schema:
            type: string
            format: date
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: pageSize
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of rides
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PaginatedResponse'
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/Ride'

  /supplier/rides/{rideId}:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
        - DRIVER
      summary: Get ride details
      parameters:
        - in: path
          name: rideId
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Ride details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ride'

  /supplier/rides/{rideId}/assign-driver:
    post:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
      summary: Assign driver and optionally vehicle to ride
      parameters:
        - in: path
          name: rideId
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [driverId]
              properties:
                driverId:
                  type: integer
                  format: int64
                vehicleId:
                  type: integer
                  format: int64
                  nullable: true
      responses:
        '200':
          description: Ride updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ride'
        '400':
          description: Invalid state

  /supplier/rides/{rideId}/status:
    post:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
        - DRIVER
      summary: Update ride status (ON_WAY, AT_PICKUP, etc.)
      parameters:
        - in: path
          name: rideId
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  $ref: '#/components/schemas/RideStatus'
      responses:
        '200':
          description: Ride status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ride'
        '400':
          description: Invalid transition

  /supplier/payouts:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
      summary: List payouts for current supplier
      parameters:
        - in: query
          name: status
          schema:
            $ref: '#/components/schemas/SupplierPayoutStatus'
        - in: query
          name: page
          schema:
            type: integer
            default: 1
        - in: query
          name: pageSize
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of payouts
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PaginatedResponse'
                  - type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/SupplierPayout'

  /supplier/dashboard:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      x-roles:
        - SUPPLIER_OWNER
        - DISPATCHER
      summary: Get supplier dashboard summary
      responses:
        '200':
          description: Supplier KPIs
          content:
            application/json:
              schema:
                type: object
                properties:
                  upcomingRides:
                    type: integer
                  completedRidesToday:
                    type: integer
                  totalEarningsThisMonth:
                    type: number
                    format: double
                  pendingPayouts:
                    type: number
                    format: double

  /admin/airports:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: List all airports (including inactive)
      responses:
        '200':
          description: List of airports
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Airport'
    post:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: Create airport
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AirportCreate'
      responses:
        '201':
          description: Airport created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Airport'

  /admin/zones:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: List all zones (including inactive)
      responses:
        '200':
          description: List of zones
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Zone'
    post:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: Create zone
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ZoneCreate'
      responses:
        '201':
          description: Zone created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Zone'

  /admin/routes:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: List all routes
      responses:
        '200':
          description: List of routes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Route'
    post:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: Create route between airport and zone
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RouteCreate'
      responses:
        '201':
          description: Route created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Route'

  /admin/suppliers:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: List all suppliers
      responses:
        '200':
          description: List of suppliers
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Supplier'
    post:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: Create supplier company
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SupplierCreate'
      responses:
        '201':
          description: Supplier created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Supplier'

  /admin/suppliers/{supplierId}:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: Get supplier details
      parameters:
        - in: path
          name: supplierId
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Supplier details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Supplier'

  /admin/suppliers/{supplierId}/verify:
    post:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: Mark supplier as verified
      parameters:
        - in: path
          name: supplierId
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Supplier verified
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Supplier'

  /admin/tariffs:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: List all tariffs across suppliers
      responses:
        '200':
          description: List of tariffs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Tariff'
    post:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: Create tariff for any supplier
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: '#/components/schemas/TariffCreate'
                - type: object
                  properties:
                    supplierId:
                      type: integer
                      format: int64
      responses:
        '201':
          description: Tariff created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tariff'

  /admin/tariffs/{tariffId}:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: Get tariff details with rules
      parameters:
        - in: path
          name: tariffId
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Tariff details
          content:
            application/json:
              schema:
                type: object
                properties:
                  tariff:
                    $ref: '#/components/schemas/Tariff'
                  rules:
                    type: array
                    items:
                      $ref: '#/components/schemas/TariffRule'

  /admin/tariffs/{tariffId}/rules:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: List rules for a tariff
      parameters:
        - in: path
          name: tariffId
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Tariff rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TariffRule'
    post:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: Add pricing rule to a tariff
      parameters:
        - in: path
          name: tariffId
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TariffRuleCreate'
      responses:
        '201':
          description: Tariff rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TariffRule'

  /admin/payouts:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: List all supplier payouts
      parameters:
        - in: query
          name: status
          schema:
            $ref: '#/components/schemas/SupplierPayoutStatus'
      responses:
        '200':
          description: List of payouts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SupplierPayout'

  /admin/payouts/{payoutId}/mark-paid:
    post:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: Mark payout as paid
      parameters:
        - in: path
          name: payoutId
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Payout updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SupplierPayout'

  /admin/bookings:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: List all bookings
      parameters:
        - in: query
          name: status
          schema:
            $ref: '#/components/schemas/BookingStatus'
        - in: query
          name: fromDate
          schema:
            type: string
            format: date
        - in: query
          name: toDate
          schema:
            type: string
            format: date
      responses:
        '200':
          description: List of bookings
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Booking'

  /admin/dashboard:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      x-roles:
        - ADMIN
      summary: Get admin dashboard KPIs
      responses:
        '200':
          description: Admin KPIs
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalBookingsToday:
                    type: integer
                  totalRevenueToday:
                    type: number
                    format: double
                  activeSuppliers:
                    type: integer
                  pendingPayouts:
                    type: number
                    format: double

  # ============================
  # Dispatch Endpoints
  # ============================

  /dispatch/dashboard:
    get:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Get dispatch dashboard stats
      description: Returns real-time stats for dispatch operations
      responses:
        '200':
          description: Dashboard statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  stats:
                    type: object
                    properties:
                      todayRides:
                        type: integer
                      activeDrivers:
                        type: integer
                      ongoingRides:
                        type: integer
                      pendingAssignment:
                        type: integer
                      delayedFlights:
                        type: integer
                      openIssues:
                        type: integer

  /dispatch/locations:
    get:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Get driver locations
      description: Returns real-time driver locations with status and current ride info
      parameters:
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/DriverLocationStatus'
          description: Filter by driver status
      responses:
        '200':
          description: Driver locations
          content:
            application/json:
              schema:
                type: object
                properties:
                  drivers:
                    type: array
                    items:
                      $ref: '#/components/schemas/DriverLocation'
    post:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Update driver location
      description: Update a driver's GPS location and status
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [driverId, latitude, longitude]
              properties:
                driverId:
                  type: integer
                latitude:
                  type: number
                longitude:
                  type: number
                heading:
                  type: number
                speed:
                  type: number
                accuracy:
                  type: number
                batteryLevel:
                  type: integer
                status:
                  $ref: '#/components/schemas/DriverLocationStatus'
      responses:
        '200':
          description: Location updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /dispatch/flights:
    get:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Get flight tracking data
      description: Returns flight status for upcoming bookings
      parameters:
        - name: filter
          in: query
          schema:
            type: string
            enum: [all, delayed, arriving, landed]
          description: Filter flights by status
      responses:
        '200':
          description: Flight tracking data
          content:
            application/json:
              schema:
                type: object
                properties:
                  flights:
                    type: array
                    items:
                      $ref: '#/components/schemas/FlightTracking'
    post:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Add flight tracking
      description: Add flight tracking for a booking
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [bookingId, flightNumber, flightDate]
              properties:
                bookingId:
                  type: integer
                flightNumber:
                  type: string
                flightDate:
                  type: string
                  format: date
                departureAirport:
                  type: string
                arrivalAirport:
                  type: string
                scheduledDeparture:
                  type: string
                  format: date-time
                scheduledArrival:
                  type: string
                  format: date-time
      responses:
        '200':
          description: Flight tracking added
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
    put:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Update flight tracking
      description: Update flight status and arrival info
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: integer
                status:
                  $ref: '#/components/schemas/FlightTrackingStatus'
                estimatedArrival:
                  type: string
                  format: date-time
                actualArrival:
                  type: string
                  format: date-time
                delayMinutes:
                  type: integer
                delayReason:
                  type: string
                terminal:
                  type: string
                gate:
                  type: string
                baggageClaim:
                  type: string
                trackingSource:
                  type: string
      responses:
        '200':
          description: Flight tracking updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /dispatch/issues:
    get:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Get dispatch issues
      description: Returns issues and incidents requiring attention
      parameters:
        - name: filter
          in: query
          schema:
            type: string
            enum: [all, open, in_progress, critical, resolved]
          description: Filter issues by status
      responses:
        '200':
          description: Dispatch issues
          content:
            application/json:
              schema:
                type: object
                properties:
                  issues:
                    type: array
                    items:
                      $ref: '#/components/schemas/DispatchIssue'
    post:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Create dispatch issue
      description: Report a new issue or incident
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type, severity, title]
              properties:
                bookingId:
                  type: integer
                rideId:
                  type: integer
                type:
                  $ref: '#/components/schemas/DispatchIssueType'
                severity:
                  $ref: '#/components/schemas/DispatchIssueSeverity'
                title:
                  type: string
                description:
                  type: string
                reportedBy:
                  type: string
                  enum: [CUSTOMER, DRIVER, DISPATCHER, SYSTEM]
      responses:
        '200':
          description: Issue created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  issueId:
                    type: integer
    put:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Update dispatch issue
      description: Update issue status or resolution
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: integer
                status:
                  $ref: '#/components/schemas/DispatchIssueStatus'
                resolution:
                  type: string
                resolvedBy:
                  type: integer
      responses:
        '200':
          description: Issue updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /dispatch/messages:
    get:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Get message conversations
      description: Returns recent message threads with unread counts
      responses:
        '200':
          description: Conversations list
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversations:
                    type: array
                    items:
                      $ref: '#/components/schemas/Conversation'

  /dispatch/messages/{bookingId}:
    get:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Get messages for booking
      description: Returns message thread for a specific booking
      parameters:
        - name: bookingId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  messages:
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
    post:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Send message
      description: Send a message in a booking thread
      parameters:
        - name: bookingId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [message, senderType]
              properties:
                message:
                  type: string
                senderType:
                  $ref: '#/components/schemas/MessageSenderType'
                senderName:
                  type: string
                messageType:
                  $ref: '#/components/schemas/MessageType'
                attachmentUrl:
                  type: string
                locationLat:
                  type: number
                locationLng:
                  type: number
      responses:
        '200':
          description: Message sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  messageId:
                    type: integer

  /dispatch/notifications:
    get:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Get notifications
      description: Returns notifications for dispatch operations
      parameters:
        - name: recipientType
          in: query
          schema:
            $ref: '#/components/schemas/NotificationRecipientType'
        - name: recipientId
          in: query
          schema:
            type: integer
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/NotificationStatus'
        - name: channel
          in: query
          schema:
            $ref: '#/components/schemas/NotificationChannel'
      responses:
        '200':
          description: Notifications
          content:
            application/json:
              schema:
                type: object
                properties:
                  notifications:
                    type: array
                    items:
                      $ref: '#/components/schemas/Notification'
    post:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Create notification
      description: Create a new notification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [recipientType, type, title, message, channel]
              properties:
                recipientType:
                  $ref: '#/components/schemas/NotificationRecipientType'
                recipientId:
                  type: integer
                recipientEmail:
                  type: string
                recipientPhone:
                  type: string
                type:
                  $ref: '#/components/schemas/NotificationType'
                title:
                  type: string
                message:
                  type: string
                bookingId:
                  type: integer
                rideId:
                  type: integer
                channel:
                  $ref: '#/components/schemas/NotificationChannel'
                metadata:
                  type: object
      responses:
        '200':
          description: Notification created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  notificationId:
                    type: integer
    put:
      tags: [Dispatch]
      security:
        - bearerAuth: []
      summary: Update notification status
      description: Update notification status or mark as read
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                id:
                  type: integer
                ids:
                  type: array
                  items:
                    type: integer
                status:
                  $ref: '#/components/schemas/NotificationStatus'
                markAsRead:
                  type: boolean
      responses:
        '200':
          description: Notification updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  # ============================
  # V1 B2B API Endpoints (Agency Integration)
  # ============================

  /v1/search:
    get:
      tags: [V1 API]
      security:
        - apiKeyAuth: []
      summary: Search available transfers
      description: Search for available transfer options between airport and zone
      parameters:
        - name: airport
          in: query
          required: true
          schema:
            type: string
          description: Airport IATA code (e.g., IST, AYT)
        - name: zone
          in: query
          required: true
          schema:
            type: integer
          description: Zone ID
        - name: date
          in: query
          required: true
          schema:
            type: string
            format: date
          description: Pickup date (YYYY-MM-DD)
        - name: time
          in: query
          schema:
            type: string
          description: Pickup time (HH:MM)
        - name: passengers
          in: query
          required: true
          schema:
            type: integer
          description: Number of passengers
        - name: direction
          in: query
          schema:
            type: string
            enum: [FROM_AIRPORT, TO_AIRPORT]
      responses:
        '200':
          description: Available transfer options
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  options:
                    type: array
                    items:
                      type: object
                      properties:
                        vehicleType:
                          type: string
                        price:
                          type: number
                        currency:
                          type: string
                        maxPassengers:
                          type: integer
                        luggageCapacity:
                          type: integer

  /v1/quote:
    post:
      tags: [V1 API]
      security:
        - apiKeyAuth: []
      summary: Get detailed quote with pricing
      description: Get a detailed price quote with extras and validity period
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [airportCode, zoneId, vehicleType, date, time, passengers]
              properties:
                airportCode:
                  type: string
                zoneId:
                  type: integer
                vehicleType:
                  $ref: '#/components/schemas/VehicleType'
                date:
                  type: string
                  format: date
                time:
                  type: string
                passengers:
                  type: integer
                direction:
                  type: string
                  enum: [FROM_AIRPORT, TO_AIRPORT]
                extras:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Quote details
          content:
            application/json:
              schema:
                type: object
                properties:
                  quoteId:
                    type: string
                  price:
                    type: number
                  currency:
                    type: string
                  validUntil:
                    type: string
                    format: date-time

  /v1/booking:
    post:
      tags: [V1 API]
      security:
        - apiKeyAuth: []
      summary: Create booking from quote
      description: Create a new booking using a quote or direct parameters
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [airportCode, zoneId, vehicleType, pickupDate, pickupTime, direction, passengers, customer]
              properties:
                quoteId:
                  type: string
                  description: Quote ID from /v1/quote (optional)
                airportCode:
                  type: string
                zoneId:
                  type: integer
                vehicleType:
                  $ref: '#/components/schemas/VehicleType'
                pickupDate:
                  type: string
                  format: date
                pickupTime:
                  type: string
                direction:
                  type: string
                  enum: [FROM_AIRPORT, TO_AIRPORT]
                passengers:
                  type: integer
                flightNumber:
                  type: string
                pickupAddress:
                  type: string
                dropoffAddress:
                  type: string
                customer:
                  type: object
                  required: [name, email, phone]
                  properties:
                    name:
                      type: string
                    email:
                      type: string
                    phone:
                      type: string
                agencyRef:
                  type: string
                  description: Agency's internal reference
                specialRequests:
                  type: string
      responses:
        '201':
          description: Booking created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  booking:
                    type: object
                    properties:
                      id:
                        type: integer
                      publicCode:
                        type: string
                      status:
                        type: string
                      totalPrice:
                        type: number
                      currency:
                        type: string

  /v1/booking/{bookingId}:
    get:
      tags: [V1 API]
      security:
        - apiKeyAuth: []
      summary: Get booking details
      parameters:
        - name: bookingId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Booking details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Booking'

  /v1/booking/{bookingId}/cancel:
    post:
      tags: [V1 API]
      security:
        - apiKeyAuth: []
      summary: Cancel booking
      parameters:
        - name: bookingId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
      responses:
        '200':
          description: Booking cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  refundAmount:
                    type: number
                  refundCurrency:
                    type: string

  # ============================
  # Agency Portal Endpoints
  # ============================

  /agency/me:
    get:
      tags: [Agency]
      security:
        - bearerAuth: []
      summary: Get agency profile
      responses:
        '200':
          description: Agency profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Agency'

  /agency/bookings:
    get:
      tags: [Agency]
      security:
        - bearerAuth: []
      summary: List agency bookings
      parameters:
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/BookingStatus'
        - name: dateFrom
          in: query
          schema:
            type: string
            format: date
        - name: dateTo
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: List of agency bookings
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Booking'

  /agency/dashboard:
    get:
      tags: [Agency]
      security:
        - bearerAuth: []
      summary: Get agency dashboard
      responses:
        '200':
          description: Dashboard stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalBookings:
                    type: integer
                  monthlyBookings:
                    type: integer
                  creditBalance:
                    type: number
                  pendingBookings:
                    type: integer

  /agency/credits:
    get:
      tags: [Agency]
      security:
        - bearerAuth: []
      summary: Get credit balance and history
      responses:
        '200':
          description: Credit information
          content:
            application/json:
              schema:
                type: object
                properties:
                  balance:
                    type: number
                  currency:
                    type: string
                  transactions:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        amount:
                          type: number
                        type:
                          type: string
                        description:
                          type: string
                        createdAt:
                          type: string
                          format: date-time

  # ============================
  # Supplier Settings Endpoints
  # ============================

  /supplier/settings/profile:
    put:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: Update user profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                fullName:
                  type: string
                phone:
                  type: string
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /supplier/settings/company:
    put:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: Update company details
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                legalName:
                  type: string
                taxNumber:
                  type: string
                contactName:
                  type: string
                contactEmail:
                  type: string
                contactPhone:
                  type: string
                whatsapp:
                  type: string
                country:
                  type: string
                city:
                  type: string
                address:
                  type: string
                description:
                  type: string
      responses:
        '200':
          description: Company updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /supplier/settings/bank:
    put:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: Update bank/payment details
      description: Update supplier's bank account and payment method preferences
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                bankName:
                  type: string
                bankAccountName:
                  type: string
                bankIban:
                  type: string
                bankSwift:
                  type: string
                bankCountry:
                  type: string
                paymentEmail:
                  type: string
                  description: PayPal or Wise email
                preferredPaymentMethod:
                  $ref: '#/components/schemas/PaymentMethod'
      responses:
        '200':
          description: Bank details updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /supplier/settings/password:
    put:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: Change password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [currentPassword, newPassword]
              properties:
                currentPassword:
                  type: string
                newPassword:
                  type: string
      responses:
        '200':
          description: Password changed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  # ============================
  # Supplier Document Management
  # ============================

  /supplier/documents:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: List company documents
      responses:
        '200':
          description: Company documents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Document'
    post:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: Upload company document
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [docType, fileUrl]
              properties:
                docType:
                  $ref: '#/components/schemas/DocumentType'
                docName:
                  type: string
                fileUrl:
                  type: string
                expiryDate:
                  type: string
                  format: date
      responses:
        '201':
          description: Document uploaded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  documentId:
                    type: integer

  /supplier/upload:
    post:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: Upload file to storage
      description: Upload a file to cloud storage (DigitalOcean Spaces)
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                folder:
                  type: string
                  description: Destination folder
      responses:
        '200':
          description: File uploaded
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                  key:
                    type: string
                  filename:
                    type: string
                  size:
                    type: integer
                  type:
                    type: string

  /supplier/drivers/{driverId}/documents:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: List driver documents
      parameters:
        - name: driverId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Driver documents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DriverDocument'
    post:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: Upload driver document
      parameters:
        - name: driverId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [docType, fileUrl]
              properties:
                docType:
                  $ref: '#/components/schemas/DriverDocumentType'
                docName:
                  type: string
                fileUrl:
                  type: string
                expiryDate:
                  type: string
                  format: date
      responses:
        '201':
          description: Document uploaded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  documentId:
                    type: integer

  /supplier/vehicles/{vehicleId}/documents:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: List vehicle documents
      parameters:
        - name: vehicleId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Vehicle documents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VehicleDocument'
    post:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: Upload vehicle document
      parameters:
        - name: vehicleId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [docType, fileUrl]
              properties:
                docType:
                  $ref: '#/components/schemas/VehicleDocumentType'
                docName:
                  type: string
                fileUrl:
                  type: string
                expiryDate:
                  type: string
                  format: date
      responses:
        '201':
          description: Document uploaded
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  documentId:
                    type: integer

  # ============================
  # Supplier Zones & Routes
  # ============================

  /supplier/zones:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: List service zones
      responses:
        '200':
          description: Service zones
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ServiceZone'
    post:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: Add service zones
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [airportIds]
              properties:
                airportIds:
                  type: array
                  items:
                    type: integer
                maxDistanceKm:
                  type: number
      responses:
        '200':
          description: Zones added
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  added:
                    type: integer

  /supplier/routes:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: List supplier routes
      responses:
        '200':
          description: Supplier routes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Route'

  /supplier/routes/for-pricing:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: Get routes available for pricing
      description: Returns routes that the supplier can set tariffs for based on their service zones
      responses:
        '200':
          description: Routes for pricing
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    airportCode:
                      type: string
                    airportName:
                      type: string
                    zoneName:
                      type: string

  # ============================
  # Supplier Reviews
  # ============================

  /supplier/reviews:
    get:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: List supplier reviews
      parameters:
        - name: responded
          in: query
          schema:
            type: boolean
          description: Filter by response status
      responses:
        '200':
          description: Reviews with stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  reviews:
                    type: array
                    items:
                      $ref: '#/components/schemas/Review'
                  stats:
                    type: object
                    properties:
                      totalReviews:
                        type: integer
                      pendingResponse:
                        type: integer
                      avgRating:
                        type: number

  /supplier/reviews/{reviewId}/respond:
    post:
      tags: [Supplier]
      security:
        - bearerAuth: []
      summary: Respond to review
      parameters:
        - name: reviewId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [response]
              properties:
                response:
                  type: string
      responses:
        '200':
          description: Response added
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  # ============================
  # Public Booking Modifications
  # ============================

  /public/bookings/{publicCode}/cancel:
    get:
      tags: [Public]
      summary: Preview cancellation
      parameters:
        - name: publicCode
          in: path
          required: true
          schema:
            type: string
        - name: email
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Cancellation preview
          content:
            application/json:
              schema:
                type: object
                properties:
                  canCancel:
                    type: boolean
                  refundAmount:
                    type: number
                  refundPercentage:
                    type: number
                  policy:
                    type: string
    post:
      tags: [Public]
      summary: Cancel booking
      parameters:
        - name: publicCode
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                reason:
                  type: string
      responses:
        '200':
          description: Booking cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  refundAmount:
                    type: number

  /public/bookings/{publicCode}/modify:
    get:
      tags: [Public]
      summary: Preview modification options
      parameters:
        - name: publicCode
          in: path
          required: true
          schema:
            type: string
        - name: email
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Modification options
          content:
            application/json:
              schema:
                type: object
                properties:
                  canModify:
                    type: boolean
                  modifiableFields:
                    type: array
                    items:
                      type: string
                  hoursUntilPickup:
                    type: number
    post:
      tags: [Public]
      summary: Modify booking
      parameters:
        - name: publicCode
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                pickupTime:
                  type: string
                  format: date-time
                flightNumber:
                  type: string
                pickupAddress:
                  type: string
                dropoffAddress:
                  type: string
                specialRequests:
                  type: string
                passengerName:
                  type: string
                passengerPhone:
                  type: string
                passengerEmail:
                  type: string
      responses:
        '200':
          description: Booking modified
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  modifications:
                    type: array
                    items:
                      type: string

  # ============================
  # Public Currency & Reviews
  # ============================

  /public/currency:
    get:
      tags: [Public]
      summary: Get exchange rates
      responses:
        '200':
          description: Currency rates
          content:
            application/json:
              schema:
                type: object
                properties:
                  baseCurrency:
                    type: string
                  rates:
                    type: object
                    additionalProperties:
                      type: number
                  lastUpdated:
                    type: string
                    format: date-time
    post:
      tags: [Public]
      summary: Convert currency
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [amount, from, to]
              properties:
                amount:
                  type: number
                from:
                  type: string
                to:
                  type: string
      responses:
        '200':
          description: Conversion result
          content:
            application/json:
              schema:
                type: object
                properties:
                  original:
                    type: number
                  converted:
                    type: number
                  rate:
                    type: number

  /public/reviews:
    get:
      tags: [Public]
      summary: Get supplier reviews
      parameters:
        - name: supplierId
          in: query
          required: true
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Supplier reviews
          content:
            application/json:
              schema:
                type: object
                properties:
                  reviews:
                    type: array
                    items:
                      $ref: '#/components/schemas/Review'
                  stats:
                    type: object
                    properties:
                      avgRating:
                        type: number
                      totalReviews:
                        type: integer
    post:
      tags: [Public]
      summary: Submit review
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [bookingCode, customerEmail, ratingOverall]
              properties:
                bookingCode:
                  type: string
                customerEmail:
                  type: string
                ratingOverall:
                  type: number
                  minimum: 1
                  maximum: 5
                ratingPunctuality:
                  type: number
                  minimum: 1
                  maximum: 5
                ratingVehicle:
                  type: number
                  minimum: 1
                  maximum: 5
                ratingDriver:
                  type: number
                  minimum: 1
                  maximum: 5
                reviewText:
                  type: string
      responses:
        '201':
          description: Review submitted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  reviewId:
                    type: integer

  # ============================
  # Real-Time Tracking
  # ============================

  /tracking/{bookingCode}:
    get:
      tags: [Public]
      summary: Real-time ride tracking (SSE)
      description: Server-Sent Events stream for real-time driver location updates
      parameters:
        - name: bookingCode
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: SSE stream with location updates
          content:
            text/event-stream:
              schema:
                type: object
                properties:
                  event:
                    type: string
                    example: location_update
                  data:
                    type: object
                    properties:
                      lat:
                        type: number
                      lng:
                        type: number
                      heading:
                        type: number
                      status:
                        type: string
                      eta:
                        type: integer
                        description: ETA in minutes

  # ============================
  # Admin Additional Endpoints
  # ============================

  /admin/me:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      summary: Get admin profile
      responses:
        '200':
          description: Admin user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /admin/impersonate:
    post:
      tags: [Admin]
      security:
        - bearerAuth: []
      summary: Impersonate supplier
      description: Login as a supplier user for support purposes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [supplierId]
              properties:
                supplierId:
                  type: integer
      responses:
        '200':
          description: Impersonation started
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  redirectUrl:
                    type: string
    delete:
      tags: [Admin]
      security:
        - bearerAuth: []
      summary: Stop impersonation
      responses:
        '200':
          description: Impersonation ended
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  redirectUrl:
                    type: string

  /admin/users:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      summary: List admin users
      responses:
        '200':
          description: Admin users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
    post:
      tags: [Admin]
      security:
        - bearerAuth: []
      summary: Create admin user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /admin/documents:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      summary: List all supplier documents
      parameters:
        - name: supplierId
          in: query
          schema:
            type: integer
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, verified, rejected]
      responses:
        '200':
          description: Documents list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Document'

  /admin/documents/{documentId}/verify:
    post:
      tags: [Admin]
      security:
        - bearerAuth: []
      summary: Verify document
      parameters:
        - name: documentId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                verified:
                  type: boolean
                notes:
                  type: string
      responses:
        '200':
          description: Document verified
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /admin/settings:
    get:
      tags: [Admin]
      security:
        - bearerAuth: []
      summary: Get system settings
      responses:
        '200':
          description: System settings
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
    put:
      tags: [Admin]
      security:
        - bearerAuth: []
      summary: Update system settings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: Settings updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  # =====================================================
  # PROMO CODES - Admin Endpoints
  # =====================================================

  /admin/promo-codes:
    get:
      tags: [Promo Codes, Admin]
      security:
        - bearerAuth: []
      summary: List all promo codes
      description: Get all promo codes with usage statistics
      responses:
        '200':
          description: List of promo codes
          content:
            application/json:
              schema:
                type: object
                properties:
                  promoCodes:
                    type: array
                    items:
                      $ref: '#/components/schemas/PromoCode'
    post:
      tags: [Promo Codes, Admin]
      security:
        - bearerAuth: []
      summary: Create a new promo code
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - code
                - discountType
                - discountValue
              properties:
                code:
                  type: string
                  example: SUMMER2025
                description:
                  type: string
                discountType:
                  type: string
                  enum: [PERCENTAGE, FIXED_AMOUNT]
                discountValue:
                  type: number
                currency:
                  type: string
                  default: EUR
                minBookingAmount:
                  type: number
                  default: 0
                maxDiscountAmount:
                  type: number
                usageLimit:
                  type: integer
                perUserLimit:
                  type: integer
                  default: 1
                validFrom:
                  type: string
                  format: date-time
                validUntil:
                  type: string
                  format: date-time
                isActive:
                  type: boolean
                  default: true
                isExitIntent:
                  type: boolean
                  default: false
                applicableRoutes:
                  type: array
                  items:
                    type: integer
                applicableVehicleTypes:
                  type: array
                  items:
                    type: string
      responses:
        '201':
          description: Promo code created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  promoCodeId:
                    type: integer
                  code:
                    type: string

  /admin/promo-codes/{promoCodeId}:
    get:
      tags: [Promo Codes, Admin]
      security:
        - bearerAuth: []
      summary: Get promo code details
      parameters:
        - name: promoCodeId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Promo code details
          content:
            application/json:
              schema:
                type: object
                properties:
                  promoCode:
                    $ref: '#/components/schemas/PromoCode'
    put:
      tags: [Promo Codes, Admin]
      security:
        - bearerAuth: []
      summary: Update promo code
      parameters:
        - name: promoCodeId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                description:
                  type: string
                discountValue:
                  type: number
                isActive:
                  type: boolean
                validUntil:
                  type: string
                  format: date-time
      responses:
        '200':
          description: Promo code updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
    delete:
      tags: [Promo Codes, Admin]
      security:
        - bearerAuth: []
      summary: Delete promo code
      description: Soft deletes (deactivates) if has usage history, hard deletes otherwise
      parameters:
        - name: promoCodeId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Promo code deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  # =====================================================
  # PROMO CODES - Public Endpoints
  # =====================================================

  /public/promo-codes/validate:
    post:
      tags: [Promo Codes, Public]
      summary: Validate a promo code
      description: |
        Validates a promo code and calculates the discount amount.
        Rate limited to 30 requests per minute.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - code
              properties:
                code:
                  type: string
                  example: SAVE10
                bookingAmount:
                  type: number
                  description: Optional - if provided, returns calculated discount
                customerEmail:
                  type: string
                  description: Optional - checks per-user limit
                routeId:
                  type: integer
                vehicleType:
                  type: string
      responses:
        '200':
          description: Validation result
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
            X-RateLimit-Remaining:
              schema:
                type: integer
            X-RateLimit-Reset:
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromoCodeValidationResult'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'

  /public/promo-codes/exit-intent:
    get:
      tags: [Promo Codes, Public]
      summary: Get exit-intent promo code
      description: Returns the active exit-intent promo code for showing in exit popups
      responses:
        '200':
          description: Exit-intent promo
          content:
            application/json:
              schema:
                type: object
                properties:
                  available:
                    type: boolean
                  promo:
                    type: object
                    properties:
                      code:
                        type: string
                      description:
                        type: string
                      discountType:
                        type: string
                      discountValue:
                        type: number
                      currency:
                        type: string
                      displayText:
                        type: string
                        example: "10% OFF"
                      headline:
                        type: string
                        example: "Wait! Get 10% Off Your Transfer"

  # =====================================================
  # CRYPTOCURRENCY PAYMENTS
  # =====================================================

  /public/crypto-rates:
    get:
      tags: [Crypto, Public]
      summary: Get live cryptocurrency rates
      description: |
        Returns live EUR-to-crypto exchange rates for supported cryptocurrencies.
        Rates are fetched from CoinGecko API and cached for 60 seconds.
      responses:
        '200':
          description: Current crypto rates in EUR
          content:
            application/json:
              schema:
                type: object
                properties:
                  BTC:
                    type: number
                    format: float
                    description: Bitcoin price in EUR
                    example: 95432.15
                  ETH:
                    type: number
                    format: float
                    description: Ethereum price in EUR
                    example: 3521.42
                  XRP:
                    type: number
                    format: float
                    description: Ripple price in EUR
                    example: 2.15
        '500':
          description: Failed to fetch rates
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /public/payments/crypto:
    post:
      tags: [Crypto, Public]
      summary: Submit crypto payment details
      description: |
        Submit cryptocurrency payment details after sending payment.
        The booking will be marked as PENDING_VERIFICATION until payment is confirmed.

        **Supported cryptocurrencies:**
        - BTC (Bitcoin)
        - ETH (Ethereum)
        - XRP (Ripple) - requires destination memo/tag

        After submission, the admin team will verify the transaction on the blockchain.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - bookingCode
                - currency
                - txHash
              properties:
                bookingCode:
                  type: string
                  description: The booking's public code
                  example: ATP6QYYC7
                currency:
                  $ref: '#/components/schemas/CryptoCurrency'
                amount:
                  type: number
                  format: float
                  description: Amount sent in crypto
                  example: 0.00125
                txHash:
                  type: string
                  description: Transaction hash/ID from the blockchain
                  example: "0x1234567890abcdef..."
                walletAddress:
                  type: string
                  description: Wallet address payment was sent to
                  example: "0x36E444aa90a9515f6AC2062202a64D4486B9746F"
      responses:
        '200':
          description: Payment details submitted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Crypto payment details submitted. We will verify and confirm your booking shortly."
        '400':
          description: Missing required fields
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Missing required fields: bookingCode, currency, txHash"
        '404':
          description: Booking not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Booking not found"
        '500':
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  # =====================================================
  # CUSTOMER AUTHENTICATION
  # =====================================================

  /customer/auth:
    post:
      tags: [Customer]
      summary: Customer authentication
      description: |
        Unified endpoint for customer authentication actions:
        - **register**: Create new account with email/password
        - **login**: Sign in with email/password
        - **google**: Sign in or register with Google OAuth
        - **logout**: End current session

        Rate limited to 5 requests per minute for security.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CustomerAuthRequest'
            examples:
              register:
                summary: Register new account
                value:
                  action: register
                  email: john@example.com
                  password: securePassword123
                  firstName: John
                  lastName: Doe
                  phone: "+1234567890"
                  marketingConsent: true
              login:
                summary: Login with email/password
                value:
                  action: login
                  email: john@example.com
                  password: securePassword123
              google:
                summary: Login with Google
                value:
                  action: google
                  credential: eyJhbGciOiJSUzI1NiIsInR5cCI6...
              logout:
                summary: Logout
                value:
                  action: logout
      responses:
        '200':
          description: Authentication successful
          headers:
            Set-Cookie:
              description: Session cookie (for login/register/google)
              schema:
                type: string
            X-RateLimit-Limit:
              schema:
                type: integer
            X-RateLimit-Remaining:
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerAuthResponse'
        '400':
          description: Invalid request or validation error
        '401':
          description: Invalid credentials
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'

  /customer/me:
    get:
      tags: [Customer]
      summary: Get customer profile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Customer profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  customer:
                    $ref: '#/components/schemas/Customer'
        '401':
          description: Not authenticated
    patch:
      tags: [Customer]
      summary: Update customer profile
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                firstName:
                  type: string
                lastName:
                  type: string
                phone:
                  type: string
                preferredCurrency:
                  type: string
                marketingConsent:
                  type: boolean
                newsletterSubscribed:
                  type: boolean
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  customer:
                    type: object
                    properties:
                      firstName:
                        type: string
                      lastName:
                        type: string
                      phone:
                        type: string
                      preferredCurrency:
                        type: string

  /customer/bookings:
    get:
      tags: [Customer]
      summary: Get customer booking history
      security:
        - bearerAuth: []
      description: Returns upcoming and past bookings for the authenticated customer
      responses:
        '200':
          description: Customer bookings
          content:
            application/json:
              schema:
                type: object
                properties:
                  upcoming:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        publicCode:
                          type: string
                        pickupDatetime:
                          type: string
                          format: date-time
                        pickupAddress:
                          type: string
                        dropoffAddress:
                          type: string
                        vehicleType:
                          type: string
                        totalPrice:
                          type: number
                        currency:
                          type: string
                        status:
                          type: string
                  past:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        publicCode:
                          type: string
                        pickupDatetime:
                          type: string
                          format: date-time
                        pickupAddress:
                          type: string
                        dropoffAddress:
                          type: string
                        vehicleType:
                          type: string
                        totalPrice:
                          type: number
                        currency:
                          type: string
                        status:
                          type: string
                  stats:
                    type: object
                    properties:
                      totalBookings:
                        type: integer
                      upcomingCount:
                        type: integer
                      pastCount:
                        type: integer
        '401':
          description: Not authenticated

  /customer/convert-guest:
    post:
      tags: [Customer]
      summary: Convert guest booking to customer account
      description: |
        After completing a booking as a guest, customers can create an account to:
        - Track all their bookings in one place
        - Get faster checkout on future bookings
        - Earn loyalty points

        This endpoint supports both password-based registration and Google OAuth.
        If an account with the email already exists, the customer must log in to link the booking.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [bookingCode, email]
              properties:
                bookingCode:
                  type: string
                  description: The public booking code to link to the account
                  example: TRF-ABC123
                email:
                  type: string
                  format: email
                  description: Email address (must match the booking's lead passenger email)
                password:
                  type: string
                  minLength: 8
                  description: Password for the new account (required if not using Google)
                googleCredential:
                  type: string
                  description: Google OAuth JWT credential (alternative to password)
                name:
                  type: string
                  description: Customer's full name (optional, uses booking passenger name if not provided)
                linkToExisting:
                  type: boolean
                  default: false
                  description: If true, attempts to log in to existing account and link booking
      responses:
        '200':
          description: Account created or booking linked successfully
          headers:
            Set-Cookie:
              schema:
                type: string
              description: HTTP-only session cookie for authentication
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      success:
                        type: boolean
                        example: true
                      customerId:
                        type: integer
                      isNewUser:
                        type: boolean
                      linkedBookings:
                        type: integer
                        description: Number of bookings linked to the account
                  - type: object
                    properties:
                      success:
                        type: boolean
                        example: false
                      accountExists:
                        type: boolean
                        example: true
                      message:
                        type: string
                        example: An account with this email already exists. Please log in to link this booking.
        '400':
          description: Invalid request (missing fields, invalid password, email mismatch)
        '401':
          description: Invalid password when linking to existing account
        '404':
          description: Booking not found or email does not match
        '429':
          description: Too many requests

  # =====================================================
  # WEBHOOKS - V1 API
  # =====================================================

  /v1/webhooks:
    get:
      tags: [Webhooks, V1 API]
      security:
        - apiKeyAuth: []
      summary: List webhook subscriptions
      description: Get all webhook subscriptions for the authenticated agency
      responses:
        '200':
          description: List of webhook subscriptions
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
            X-RateLimit-Remaining:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: object
                properties:
                  subscriptions:
                    type: array
                    items:
                      $ref: '#/components/schemas/WebhookSubscription'
                  meta:
                    type: object
                    properties:
                      availableEvents:
                        type: array
                        items:
                          $ref: '#/components/schemas/WebhookEventType'
                      apiVersion:
                        type: string
        '401':
          description: Invalid API key
        '429':
          description: Rate limit exceeded
    post:
      tags: [Webhooks, V1 API]
      security:
        - apiKeyAuth: []
      summary: Create webhook subscription
      description: |
        Create a new webhook subscription. The secret is returned only once
        and must be stored securely for signature verification.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - endpointUrl
                - events
              properties:
                endpointUrl:
                  type: string
                  format: uri
                  description: Must be HTTPS
                  example: https://your-app.com/webhooks/airporttransfer
                events:
                  type: array
                  items:
                    $ref: '#/components/schemas/WebhookEventType'
                  example: [booking.created, booking.confirmed, booking.cancelled]
      responses:
        '201':
          description: Webhook subscription created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  subscription:
                    type: object
                    properties:
                      id:
                        type: integer
                      endpointUrl:
                        type: string
                      events:
                        type: array
                        items:
                          type: string
                      isActive:
                        type: boolean
                  secret:
                    type: string
                    description: Store securely - only returned once
                  warning:
                    type: string
        '400':
          description: Invalid endpoint URL or events
        '409':
          description: Subscription already exists for this endpoint
    patch:
      tags: [Webhooks, V1 API]
      security:
        - apiKeyAuth: []
      summary: Update webhook subscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - id
              properties:
                id:
                  type: integer
                  description: Subscription ID to update
                endpointUrl:
                  type: string
                  format: uri
                events:
                  type: array
                  items:
                    $ref: '#/components/schemas/WebhookEventType'
                isActive:
                  type: boolean
                regenerateSecret:
                  type: boolean
                  description: Set true to get a new secret
      responses:
        '200':
          description: Subscription updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  secret:
                    type: string
                    description: Only present if regenerateSecret was true
                  warning:
                    type: string
        '404':
          description: Subscription not found
    delete:
      tags: [Webhooks, V1 API]
      security:
        - apiKeyAuth: []
      summary: Delete webhook subscription
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: integer
          description: Subscription ID to delete
      responses:
        '200':
          description: Subscription deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '404':
          description: Subscription not found

  # =====================================================
  # V1 API - Search, Quote, Booking (with rate limits)
  # =====================================================

  /v1/search:
    get:
      tags: [V1 API]
      security:
        - apiKeyAuth: []
      summary: Search transfer options
      description: |
        Search for available transfer options.
        Rate limited to 200 requests per minute.
      parameters:
        - name: airport
          in: query
          required: true
          schema:
            type: string
          description: Airport IATA code (e.g., LHR, IST)
          example: IST
        - name: zone
          in: query
          required: true
          schema:
            type: integer
          description: Zone ID
        - name: date
          in: query
          schema:
            type: string
            format: date
          description: Pickup date
        - name: passengers
          in: query
          schema:
            type: integer
            default: 1
          description: Number of passengers
      responses:
        '200':
          description: Search results
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
            X-RateLimit-Remaining:
              schema:
                type: integer
            X-RateLimit-Reset:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        quoteId:
                          type: string
                        supplierId:
                          type: integer
                        supplierName:
                          type: string
                        supplierRating:
                          type: number
                        vehicleType:
                          type: string
                        maxPassengers:
                          type: integer
                        price:
                          type: object
                          properties:
                            amount:
                              type: number
                            currency:
                              type: string
                        route:
                          type: object
                          properties:
                            from:
                              type: string
                            to:
                              type: string
                            distanceKm:
                              type: number
                            durationMin:
                              type: integer
                  meta:
                    type: object
                    properties:
                      airport:
                        type: string
                      zoneId:
                        type: integer
                      date:
                        type: string
                      passengers:
                        type: integer
                      resultCount:
                        type: integer
                      apiVersion:
                        type: string
        '401':
          description: Invalid API key
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'

  /v1/quote:
    post:
      tags: [V1 API]
      security:
        - apiKeyAuth: []
      summary: Get detailed quote
      description: Get detailed pricing for a specific route and vehicle type
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - airportCode
                - zoneId
                - vehicleType
              properties:
                airportCode:
                  type: string
                  example: IST
                zoneId:
                  type: integer
                vehicleType:
                  $ref: '#/components/schemas/VehicleType'
                date:
                  type: string
                  format: date
                time:
                  type: string
                  example: "14:30"
                passengers:
                  type: integer
                extras:
                  type: array
                  items:
                    type: object
                    properties:
                      key:
                        type: string
                      quantity:
                        type: integer
      responses:
        '200':
          description: Detailed quote
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
            X-RateLimit-Remaining:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: object
                properties:
                  quoteId:
                    type: string
                  validUntil:
                    type: string
                    format: date-time
                  route:
                    type: object
                    properties:
                      from:
                        type: string
                      to:
                        type: string
                      distanceKm:
                        type: number
                      durationMin:
                        type: integer
                  vehicle:
                    type: object
                    properties:
                      type:
                        type: string
                      maxPassengers:
                        type: integer
                  pricing:
                    type: object
                    properties:
                      basePrice:
                        type: number
                      extrasPrice:
                        type: number
                      extras:
                        type: array
                        items:
                          type: object
                      totalPrice:
                        type: number
                      agencyCommission:
                        type: number
                      netPrice:
                        type: number
                      currency:
                        type: string
                  meta:
                    type: object
                    properties:
                      apiVersion:
                        type: string
        '404':
          description: No tariff available
        '429':
          description: Rate limit exceeded

  /v1/booking:
    post:
      tags: [V1 API]
      security:
        - apiKeyAuth: []
      summary: Create agency booking
      description: |
        Create a new booking on behalf of the agency.
        Deducts from agency credit balance.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - airportCode
                - zoneId
                - vehicleType
                - pickupDate
                - pickupTime
                - customer
              properties:
                airportCode:
                  type: string
                  example: IST
                zoneId:
                  type: integer
                vehicleType:
                  $ref: '#/components/schemas/VehicleType'
                pickupDate:
                  type: string
                  format: date
                pickupTime:
                  type: string
                  example: "14:30"
                direction:
                  type: string
                  enum: [FROM_AIRPORT, TO_AIRPORT]
                  default: FROM_AIRPORT
                passengers:
                  type: object
                  properties:
                    adults:
                      type: integer
                    children:
                      type: integer
                    luggage:
                      type: integer
                flightNumber:
                  type: string
                pickupAddress:
                  type: string
                dropoffAddress:
                  type: string
                customer:
                  type: object
                  required:
                    - name
                  properties:
                    name:
                      type: string
                    phone:
                      type: string
                    email:
                      type: string
                agencyRef:
                  type: string
                  description: Your internal reference ID
      responses:
        '200':
          description: Booking created
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
            X-RateLimit-Remaining:
              schema:
                type: integer
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  booking:
                    type: object
                    properties:
                      id:
                        type: integer
                      publicCode:
                        type: string
                      status:
                        type: string
                      agencyRef:
                        type: string
                      pickup:
                        type: object
                        properties:
                          date:
                            type: string
                          time:
                            type: string
                          address:
                            type: string
                      pricing:
                        type: object
                        properties:
                          total:
                            type: number
                          commission:
                            type: number
                          net:
                            type: number
                          currency:
                            type: string
                  meta:
                    type: object
                    properties:
                      apiVersion:
                        type: string
        '400':
          description: Invalid request or insufficient credit
        '404':
          description: No service available
        '429':
          description: Rate limit exceeded

  # =====================================================
  # CRON / SCHEDULED JOBS
  # =====================================================

  /cron/driver-reminders:
    get:
      tags: [Cron]
      summary: Send driver assignment reminders
      description: |
        **Internal cron endpoint** - Sends email reminders to suppliers who haven't assigned drivers to bookings.

        This endpoint is called by a scheduled cron job every hour. It finds bookings where:
        - Pickup is within 5-6 hours
        - No driver has been assigned yet
        - Reminder hasn't already been sent

        Sends an urgent email to the supplier with booking details and a link to assign a driver.

        **Security:** Requires CRON_SECRET header for authentication.
      parameters:
        - name: x-cron-secret
          in: header
          required: true
          schema:
            type: string
          description: Secret key for cron job authentication
      responses:
        '200':
          description: Reminders sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Processed 3 pending driver assignments"
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        rideId:
                          type: integer
                        bookingCode:
                          type: string
                        status:
                          type: string
                          enum: [sent, failed]
                        error:
                          type: string
        '401':
          description: Invalid or missing CRON_SECRET
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Unauthorized"
        '500':
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
